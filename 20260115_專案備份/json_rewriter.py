# json_rewriter.py
from __future__ import annotations

import json
import re
from typing import Any, Dict, Optional

from langchain_ollama import ChatOllama
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.output_parsers import StrOutputParser

_json_rewriter_chain = None
_rewrite_counter = 0   # ğŸ”¹ æ–°å¢ï¼šå…¨åŸŸè¨ˆæ•¸å™¨

# ğŸ”¹ æƒ³çœ‹çš„é‡å¯«ç·¨è™Ÿï¼ˆå¾ 1 é–‹å§‹è¨ˆæ•¸ï¼‰
# ä¾‹å¦‚ï¼šæƒ³çœ‹ç¬¬ 184 ç­†ï¼Œå°±å¡« {184}ï¼›æƒ³çœ‹ç¬¬ 184 å’Œ 190 ç­†ï¼Œå°±å¡« {184, 190}
DEBUG_REWRITE_INDICES = {1,5,9}  # å…ˆé è¨­ç©ºé›†åˆï¼Œéœ€è¦æ™‚æ‰‹å‹•æ”¹æˆ {184}

def _build_rewriter_chain():
    llm = ChatOllama(
        model="qwen3:latest",
        temperature=0,   # é‡å¯«ä»»å‹™å»ºè­°é–‹ 0ï¼Œç©©å®šã€å¯æ§
    )

    prompt = ChatPromptTemplate.from_messages([
        (
            "system",
            "ä½ æ˜¯ä¸€å€‹è³‡æ–™è½‰å¯«å·¥å…·ï¼Œè² è²¬æŠŠã€Œçµæ§‹åŒ–è³‡æ–™(JSON)ã€è½‰æˆ"
            "é©åˆæª¢ç´¢èˆ‡ RAG ä½¿ç”¨çš„è‡ªç„¶èªå¥æè¿°ã€‚\n"
            "è³‡æ–™ä¾†æºç‚ºå¤§åŒå¤§å­¸åŠå…¶è³‡è¨Šå·¥ç¨‹ç³»ï¼Œå…§å®¹å¯èƒ½æ˜¯ï¼šè¡Œäº‹æ›†ã€å¸«è³‡ã€èª²ç¨‹ã€æœ€æ–°æ¶ˆæ¯ã€è¯çµ¡è³‡è¨Šç­‰ã€‚\n\n"
            "ã€é‡è¦è¦å‰‡ã€‘\n"
            "1. è¼¸å‡ºçš„è³‡æ–™å¿…é ˆåŒ…å«JSONä¸­çš„æ‰€æœ‰è³‡è¨Šï¼Œä¸å¯éºæ¼ä»»ä½•è³‡è¨Šã€‚\n"
            "2. ä¸è¦è§£é‡‹ä½ åœ¨åšä»€éº¼ã€‚\n"
            "3. ç¦æ­¢è¼¸å‡ºä»»ä½•ã€Œæ€è€ƒéç¨‹ã€ã€ã€Œæ­¥é©Ÿèªªæ˜ã€æˆ–å·¥å…·æ“ä½œæè¿°ã€‚\n"
            "4. è¼¸å‡ºä¸­ä¸èƒ½å‡ºç¾ `<think>`ã€`</think>`ã€`<answer>` ç­‰æ¨™ç±¤ï¼Œä¹Ÿä¸è¦ç”¨ç¨‹å¼ç¢¼å€å¡Šã€Markdown æ¨™é¡Œã€‚\n"
            "5. å„˜é‡åŒ…å«ï¼š\n"
            "   - äººå / æ´»å‹•åç¨± / èª²ç¨‹åç¨±\n"
            "   - è·ç¨± / èº«åˆ† / å–®ä½\n"
            "   - æ™‚é–“ï¼ˆå­¸å¹´å­¸æœŸ / æ—¥æœŸ / æ™‚æ®µï¼‰\n"
            "   - åœ°é»æˆ–ç›¸é—œå–®ä½ï¼ˆå¦‚æœè³‡æ–™ä¸­æœ‰ï¼‰\n"
            "6. ä¸è¦æåˆ°ã€Œæ¬„ä½ã€ã€ŒJSONã€ã€Œschemaã€ã€Œkeyã€ç­‰å­—çœ¼ã€‚\n"
            "7. ä¸è¦è‡ªå·±æé€ è³‡æ–™ï¼Œåªèƒ½ç”¨è³‡æ–™è£¡å‡ºç¾éçš„è³‡è¨Šåšåˆç†æ”¹å¯«èˆ‡é‡çµ„ã€‚\n"
            "8. å¦‚æœè³‡æ–™å¹¾ä¹æ²’æœ‰å…§å®¹ï¼Œå°±ç°¡çŸ­èªªæ˜ã€Œé€™æ˜¯ä¸€ç­†{schema_hint}ç›¸é—œè³‡æ–™ï¼Œå…§å®¹æœ‰é™ã€ã€‚\n"
            "9. è«‹ä½¿ç”¨ç¹é«”ä¸­æ–‡ã€‚"
        ),
        # === One-shot ç¯„ä¾‹é–‹å§‹ ===
        (
            "human",
            "è³‡æ–™é¡å‹ (schema_hint)ï¼šdepartment_members\n\n"
            "ä»¥ä¸‹æ˜¯ä¸€ç­† JSON è³‡æ–™ï¼š\n"
            "```json\n"
            "{{ \"å§“å\": \"é»ƒåœ‹è»’\", \"è·ç¨±\": \"åŠ©ç†æ•™æˆ\", \"ç³»æ‰€\": \"è³‡å·¥ç³»\", "
            "\"é›»è©±\": \"(02) 2182-2928 #6551\", "
            "\"ä¿¡ç®±\": \"khhuang@gm.ttu.edu.tw\", "
            "\"è¾¦å…¬å®¤\": \"é›»æ©Ÿå¤§æ¨“8æ¨“800Cå®¤(A3-800C)\", "
            "\"å­¸æ­·\": \"åœ‹ç«‹è‡ºç£å¤§å­¸ é›»æ©Ÿå·¥ç¨‹å­¸ç³» åšå£« (2003/9 ~ 2008/6)\", "
            "\"metadata\": \"æ•™å­¸èˆ‡ç ”ç©¶é ˜åŸŸ :å¯†ç¢¼å­¸ã€è³‡è¨Šå®‰å…¨ã€ç¶²è·¯å®‰å…¨ã€ç‰©è¯ç¶²æŠ€è¡“\", "
            "\"è³‡æ–™ä¾†æº\": \"https://cse.ttu.edu.tw/p/412-1058-157.php?Lang=zh-tw\" }}"
            "```\n\n"
            "è«‹ä¾ç…§è¦å‰‡ï¼Œç”¢ç”Ÿä¸€æ®µä¸è¶…é 400 å€‹ä¸­æ–‡å­—çš„è‡ªç„¶èªå¥æè¿°ã€‚"
        ),
        (
            "ai",
            "é»ƒåœ‹è»’ç‚ºè³‡å·¥ç³»åŠ©ç†æ•™æˆï¼Œé›»è©±ç‚º(02) 2182-2928 #6551ï¼Œ"
            "ä¿¡ç®±khhuang@gm.ttu.edu.twï¼Œè¾¦å…¬å®¤ä½æ–¼é›»æ©Ÿå¤§æ¨“8æ¨“800Cå®¤(A3-800C)ã€‚"
            "å­¸æ­·ç‚ºåœ‹ç«‹è‡ºç£å¤§å­¸é›»æ©Ÿå·¥ç¨‹å­¸ç³»åšå£«ï¼ˆ2003/9ï½2008/6ï¼‰ï¼Œ"
            "æ•™å­¸èˆ‡ç ”ç©¶é ˜åŸŸåŒ…å«å¯†ç¢¼å­¸ã€è³‡è¨Šå®‰å…¨ã€ç¶²è·¯å®‰å…¨åŠç‰©è¯ç¶²æŠ€è¡“ã€‚"
            "è³‡æ–™ä¾†æºï¼šhttps://cse.ttu.edu.tw/p/412-1058-157.php?Lang=zh-tw"
        ),
        # === One-shot ç¯„ä¾‹ 2ï¼šæœ€æ–°æ¶ˆæ¯ / æ´»å‹• ===
        (
            "human",
            "è³‡æ–™é¡å‹ (schema_hint)ï¼šnews_article\n\n"
            "ä»¥ä¸‹æ˜¯ä¸€ç­† JSON è³‡æ–™ï¼š\n"
            "```json\n"
            "{{ "
            "\"url\": \"https://cse.ttu.edu.tw/p/406-1058-40124,r61.php?Lang=zh-tw\", "
            "\"title\": \"ã€ŒAI-RANèˆ‡O-RANé–‹æ”¾å¼åŸºåœ°å°å¯¦ä½œå·¥ä½œåŠã€\", "
            "\"category\": \"æœ€æ–°æ¶ˆæ¯/æ´»å‹•\", "
            "\"published_at\": \"2025-10-21\", "
            "\"content\": \"æ´»å‹•æ—¥æœŸï¼š114å¹´10æœˆ28æ—¥(äºŒ)09:00~16:30ã€‚"
            "æ´»å‹•åœ°é»ï¼šåœ‹ç«‹é™½æ˜äº¤é€šå¤§å­¸äº¤å¤§æ ¡å€å·¥ç¨‹å››é¤¨8æ¨“816å®¤(æ–°ç«¹å¸‚æ±å€å¤§å­¸è·¯1001è™Ÿ)ã€‚"
            "åƒåŠ å°è±¡ï¼šå…¨åœ‹å…¬ç§ç«‹å¤§å°ˆé™¢æ ¡è³‡å·¥ã€é€šè¨Šç¶²è·¯åŠé›»æ©Ÿç›¸é—œç§‘ç³»ä¹‹å¸«ç”Ÿã€æ³•äººç ”ç©¶å–®ä½ä»¥åŠæ–°ç«¹ç§‘å­¸åœ’å€ä¹‹ç ”ç™¼äººå“¡ã€‚"
            "æ´»å‹•å ±åæ–¹å¼ï¼šæ¡å–ç·šä¸Šå…è²»å ±åï¼Œå ±åç¶²å€ï¼šhttps://forms.gle/5S3MtGXrZhipCrHJ7ã€‚\" "
            "}}\n"
            "```\n\n"
            "è«‹ä¾ç…§è¦å‰‡ï¼Œç”¢ç”Ÿä¸€æ®µä¸è¶…é 400 å€‹ä¸­æ–‡å­—çš„è‡ªç„¶èªå¥æè¿°ã€‚"
        ),
        (
            "ai",
            "ã€ŒAI-RANèˆ‡O-RANé–‹æ”¾å¼åŸºåœ°å°å¯¦ä½œå·¥ä½œåŠã€ç‚ºæœ€æ–°æ¶ˆæ¯/æ´»å‹•ï¼Œç™¼å¸ƒæ™‚é–“ç‚º2025-10-21ã€‚"
            "æ´»å‹•æ–¼114å¹´10æœˆ28æ—¥(äºŒ)09:00~16:30èˆ‰è¡Œï¼Œåœ°é»ç‚ºåœ‹ç«‹é™½æ˜äº¤é€šå¤§å­¸äº¤å¤§æ ¡å€å·¥ç¨‹å››é¤¨8æ¨“816å®¤ï¼ˆæ–°ç«¹å¸‚æ±å€å¤§å­¸è·¯1001è™Ÿï¼‰ã€‚"
            "åƒåŠ å°è±¡åŒ…å«å…¨åœ‹å…¬ç§ç«‹å¤§å°ˆé™¢æ ¡è³‡å·¥ã€é€šè¨Šç¶²è·¯åŠé›»æ©Ÿç›¸é—œç§‘ç³»å¸«ç”Ÿã€æ³•äººç ”ç©¶å–®ä½ä»¥åŠæ–°ç«¹ç§‘å­¸åœ’å€ä¹‹ç ”ç™¼äººå“¡ï¼Œ"
            "æ¡ç·šä¸Šå…è²»å ±åï¼Œå ±åç¶²å€ç‚ºhttps://forms.gle/5S3MtGXrZhipCrHJ7ã€‚"
            "è³‡æ–™ä¾†æºï¼šhttps://cse.ttu.edu.tw/p/406-1058-40124,r61.php?Lang=zh-tw"
        ),
                # === One-shot ç¯„ä¾‹ 3ï¼šèª²ç¨‹æ­·å²ç¸½è¦½ï¼ˆcourse_history_overviewï¼‰ ===
        (
            "human",
            "è³‡æ–™é¡å‹ (schema_hint)ï¼šcourse_history_overview\n\n"
            "ä»¥ä¸‹æ˜¯ä¸€ç­† JSON è³‡æ–™ï¼š\n"
            "```json\n"
            "{{ "
            "\"å­¸å¹´å­¸æœŸ\": \"113ä¸Š\", "
            "\"å¹´ç´š\": \"ä¸€å¹´ç´š\", "
            "\"èª²ç¨‹ç¸½æ•¸\": 25, "
            "\"æœ¬æ‰¹èª²ç¨‹æ•¸\": 11, "
            "\"èª²ç¨‹åˆ—è¡¨\": [ "
            "{{ \"èª²ç¨‹åç¨±\": \"ç¾ä»£å…¬æ°‘ç´ é¤Š\", \"èª²è™Ÿ\": \"G0040B\", \"æ•™å¸«\": \"åŒ…è’¼é¾\", \"é¸åˆ¥\": \"å¿…ä¿®\", \"å­¸åˆ†\": 2.0, "
            "\"è³‡æ–™ä¾†æº\": \"https://tchinfo.ttu.edu.tw/couquery/historysbj.php\", "
            "\"æ¦‚è¦\": \"ç¾ä»£å…¬æ°‘ç´ é¤Š(G0040B) / åŒ…è’¼é¾ / å¿…ä¿® / 2.0å­¸åˆ†\" }}, "
            "{{ \"èª²ç¨‹åç¨±\": \"å‹ä½œæ•™è‚²\", \"èª²è™Ÿ\": \"G0070D\", \"æ•™å¸«\": \"è”¡ä½³å‹\", \"é¸åˆ¥\": \"å¿…ä¿®\", \"å­¸åˆ†\": 0.0, "
            "\"è³‡æ–™ä¾†æº\": \"https://tchinfo.ttu.edu.tw/couquery/historysbj.php\", "
            "\"æ¦‚è¦\": \"å‹ä½œæ•™è‚²(G0070D) / è”¡ä½³å‹ / å¿…ä¿® / 0.0å­¸åˆ†\" }}, "
            "{{ \"èª²ç¨‹åç¨±\": \"å¾®ç©åˆ†(ä¸€)\", \"èª²è™Ÿ\": \"G1011A\", \"æ•™å¸«\": \"è”¡æ´å®—\", \"é¸åˆ¥\": \"å¿…ä¿®\", \"å­¸åˆ†\": 3.0, "
            "\"è³‡æ–™ä¾†æº\": \"https://tchinfo.ttu.edu.tw/couquery/historysbj.php\", "
            "\"æ¦‚è¦\": \"å¾®ç©åˆ†(ä¸€)(G1011A) / è”¡æ´å®— / å¿…ä¿® / 3.0å­¸åˆ†\" }}, "
            "{{ \"èª²ç¨‹åç¨±\": \"è¨ˆç®—æ©Ÿæ¦‚è«–\", \"èª²è™Ÿ\": \"G1210A\", \"æ•™å¸«\": \"å‘¨æ†²æ”¿\", \"é¸åˆ¥\": \"å¿…ä¿®\", \"å­¸åˆ†\": 3.0, "
            "\"è³‡æ–™ä¾†æº\": \"https://tchinfo.ttu.edu.tw/couquery/historysbj.php\", "
            "\"æ¦‚è¦\": \"è¨ˆç®—æ©Ÿæ¦‚è«–(G1210A) / å‘¨æ†²æ”¿ / å¿…ä¿® / 3.0å­¸åˆ†\" }} "
            "], "
            "\"è³‡æ–™ä¾†æº\": \"https://tchinfo.ttu.edu.tw/couquery/historysbj.php\", "
            "\"ä¾†æºæª”æ¡ˆ\": \"data_qwen/course_history_113.json\" "
            "}}\n"
            "```\n\n"
            "è«‹ä¾ç…§è¦å‰‡ï¼Œç”¢ç”Ÿä¸€æ®µä¸è¶…é 500 å€‹ä¸­æ–‡å­—çš„è‡ªç„¶èªå¥æè¿°ï¼Œ"
        ),
        (
            "ai",
            "113ä¸Šå­¸æœŸä¸€å¹´ç´šå…±æœ‰25é–€èª²ç¨‹ï¼Œæœ¬æ¬¡æä¾›4é–€èª²ç¨‹è³‡è¨Šã€‚"
            "èª²ç¨‹åŒ…å«ç¾ä»£å…¬æ°‘ç´ é¤Šï¼ˆG0040Bï¼ŒåŒ…è’¼é¾ï¼Œå¿…ä¿®ï¼Œ2å­¸åˆ†ï¼‰ã€"
            "å‹ä½œæ•™è‚²ï¼ˆG0070Dï¼Œè”¡ä½³å‹ï¼Œå¿…ä¿®ï¼Œ0å­¸åˆ†ï¼‰ã€"
            "å¾®ç©åˆ†(ä¸€)ï¼ˆG1011Aï¼Œè”¡æ´å®—ï¼Œå¿…ä¿®ï¼Œ3å­¸åˆ†ï¼‰ã€"
            "è¨ˆç®—æ©Ÿæ¦‚è«–ï¼ˆG1210Aï¼Œå‘¨æ†²æ”¿ï¼Œå¿…ä¿®ï¼Œ3å­¸åˆ†ï¼‰ã€‚"
            "è³‡æ–™ä¾†æºï¼šhttps://tchinfo.ttu.edu.tw/couquery/historysbj.php"
        ),
                # === One-shot ç¯„ä¾‹ 4ï¼šå§Šå¦¹æ ¡åœ‹å®¶ç¸½è¦½ï¼ˆsister_school_country_overviewï¼‰ ===
        (
            "human",
            "è³‡æ–™é¡å‹ (schema_hint)ï¼šsister_school_country_overview\n\n"
            "ä»¥ä¸‹æ˜¯ä¸€ç­† JSON è³‡æ–™ï¼š\n"
            "```json\n"
            "{{\n"
            "  \"æ¨™é¡Œ\": \"å¤§åŒå¤§å­¸æ—¥æœ¬ JAPANå§Šå¦¹æ ¡ç¸½è¦½\",\n"
            "  \"æ´²åˆ¥\": \"äºæ´² (ASIA)\",\n"
            "  \"åœ‹å®¶æˆ–åœ°å€\": \"æ—¥æœ¬ JAPAN\",\n"
            "  \"å­¸æ ¡ç¸½æ•¸\": 10,\n"
            "  \"æœ¬æ®µå­¸æ ¡æ•¸\": 9,\n"
            "  \"åˆ†æ®µè³‡è¨Š\": {{\n"
            "    \"ç¬¬å¹¾éƒ¨åˆ†\": 1,\n"
            "    \"ç¸½éƒ¨åˆ†æ•¸\": 2\n"
            "  }},\n"
            "  \"å­¸æ ¡åˆ—è¡¨\": [\n"
            "    {{ \"å­¸æ ¡åç¨±\": \"åƒè‘‰å¤§å­¸\", \"å­¸æ ¡ç¶²å€\": \"https://www.chiba-u.ac.jp/\" }},\n"
            "    {{ \"å­¸æ ¡åç¨±\": \"å»£å³¶ç¶“æ¿Ÿå¤§å­¸\", \"å­¸æ ¡ç¶²å€\": \"http://www.hue.ac.jp/\" }},\n"
            "    {{ \"å­¸æ ¡åç¨±\": \"é•·å²¡é€ å½¢å¤§å­¸\", \"å­¸æ ¡ç¶²å€\": \"http://www.nagaoka-id.ac.jp/\" }},\n"
            "    {{ \"å­¸æ ¡åç¨±\": \"äº¬éƒ½å·¥è—çº–ç¶­å¤§å­¸\", \"å­¸æ ¡ç¶²å€\": \"http://www.kit.ac.jp/\" }},\n"
            "    {{ \"å­¸æ ¡åç¨±\": \"å¤§é˜ªå­¸é™¢å¤§å­¸\", \"å­¸æ ¡ç¶²å€\": \"http://www.osaka-gu.ac.jp/\" }},\n"
            "    {{ \"å­¸æ ¡åç¨±\": \"æ—©ç¨»ç”°å¤§å­¸\", \"å­¸æ ¡ç¶²å€\": \"http://www.waseda.jp/top/index-j.html\" }},\n"
            "    {{ \"å­¸æ ¡åç¨±\": \"æ­¦è—é‡å¤§å­¸\", \"å­¸æ ¡ç¶²å€\": \"http://www.musashino-u.ac.jp/\" }},\n"
            "    {{ \"å­¸æ ¡åç¨±\": \"å¤§é˜ªå·¥æ¥­å¤§å­¸\", \"å­¸æ ¡ç¶²å€\": \"http://www.oit.ac.jp/\" }},\n"
            "    {{ \"å­¸æ ¡åç¨±\": \"ç†Šæœ¬å¤§å­¸\", \"å­¸æ ¡ç¶²å€\": \"http://ewww.kumamoto-u.ac.jp/ch/\" }}\n"
            "  ],\n"
            "  \"è³‡æ–™ä¾†æº\": \"https://ao.ttu.edu.tw/p/412-1073-2438.php\"\n"
            "}}\n"
            "```\n\n"
            "è«‹ä¾ç…§è¦å‰‡ï¼Œç”¢ç”Ÿä¸€æ®µä¸è¶…é 500 å€‹ä¸­æ–‡å­—çš„è‡ªç„¶èªå¥æè¿°ï¼Œ"
            "è¦æ˜ç¢ºèªªæ˜åœ‹å®¶ã€ç¸½å­¸æ ¡æ•¸ã€ç›®å‰æ˜¯ç¬¬å¹¾éƒ¨åˆ†ï¼Œä»¥åŠæœ¬æ®µæ‰€æœ‰å­¸æ ¡åç¨±èˆ‡ç¶²å€ã€‚"
        ),
        (
            "ai",
            "å¤§åŒå¤§å­¸æ—¥æœ¬ JAPANå§Šå¦¹æ ¡ç¸½è¦½éš¸å±¬äºæ´² (ASIA)ï¼Œå…±è¨ˆ10æ‰€å§Šå¦¹æ ¡ï¼Œ"
            "æœ¬æ®µç‚ºç¬¬1éƒ¨åˆ†ï¼Œå…±2éƒ¨åˆ†ï¼Œåˆ—å‡ºå…¶ä¸­9æ‰€å­¸æ ¡ã€‚"
            "åŒ…æ‹¬åƒè‘‰å¤§å­¸ï¼ˆhttps://www.chiba-u.ac.jp/ï¼‰ã€"
            "å»£å³¶ç¶“æ¿Ÿå¤§å­¸ï¼ˆhttp://www.hue.ac.jp/ï¼‰ã€"
            "é•·å²¡é€ å½¢å¤§å­¸ï¼ˆhttp://www.nagaoka-id.ac.jp/ï¼‰ã€"
            "äº¬éƒ½å·¥è—çº–ç¶­å¤§å­¸ï¼ˆhttp://www.kit.ac.jp/ï¼‰ã€"
            "å¤§é˜ªå­¸é™¢å¤§å­¸ï¼ˆhttp://www.osaka-gu.ac.jp/ï¼‰ã€"
            "æ—©ç¨»ç”°å¤§å­¸ï¼ˆhttp://www.waseda.jp/top/index-j.htmlï¼‰ã€"
            "æ­¦è—é‡å¤§å­¸ï¼ˆhttp://www.musashino-u.ac.jp/ï¼‰ã€"
            "å¤§é˜ªå·¥æ¥­å¤§å­¸ï¼ˆhttp://www.oit.ac.jp/ï¼‰ä»¥åŠ"
            "ç†Šæœ¬å¤§å­¸ï¼ˆhttp://ewww.kumamoto-u.ac.jp/ch/ï¼‰ã€‚"
            "æ›´å¤šè³‡è¨Šå¯åƒè€ƒåœ‹éš›äº‹å‹™è™•ç¶²é ï¼šhttps://ao.ttu.edu.tw/p/412-1073-2438.php"
        ),
            # === One-shot ç¯„ä¾‹ï¼šå­¸å£«ç­ä¿®æ¥­è¦å®šï¼ˆacademic_rulesï¼‰ ===
        (
            "human",
            "è³‡æ–™é¡å‹ (schema_hint)ï¼šacademic_rules\n\n"
            "ä»¥ä¸‹æ˜¯ä¸€ç­† JSON è³‡æ–™ï¼š\n"
            "```json\n"
            "{{"
            "\"é¡åˆ¥\": \"å¤§åŒå¤§å­¸è³‡è¨Šå·¥ç¨‹å­¸ç³»å­¸å£«ç­ä¿®æ¥­è¦å®š\", "
            "\"å…§å®¹\": \"ä¸€ã€ æœ¬æ ¡è³‡è¨Šå·¥ç¨‹å­¸ç³»(ä»¥ä¸‹ç°¡ç¨±æœ¬ç³»)ç‚ºè¦ç¯„å­¸å£«ç­å­¸ç”Ÿä¿®æ¥­äº‹é …,ä¾æ“šã€Œå¤§åŒå¤§å­¸å­¸å‰‡ã€è¨‚å®šã€Œå¤§åŒå¤§å­¸è³‡è¨Šå·¥ç¨‹å­¸å£«ç­ä¿®æ¥­è¦å®šã€(ä»¥ä¸‹ç°¡ç¨±æœ¬è¦å®š)ã€‚"
            "äºŒã€ ä¿®æ¥­å¹´é™ç‚ºå››å¹´,å¾—å»¶é•·å…©å¹´,ä¼‘å­¸æœŸé–“ä¸åˆ—å…¥ä¿®æ¥­å¹´é™è¨ˆç®—ã€‚"
            "ä¸‰ã€ ç•¢æ¥­å‰é ˆæ»¿è¶³ä»¥ä¸‹è¦å®š: (ä¸€) ä¿®å¾—128 å­¸åˆ†ä»¥ä¸Šã€‚"
            "(äºŒ) æ‰€ä¿®å­¸åˆ†ä¸­é ˆå«ç³»è¨‚å¿…ä¿®ç§‘ç›®ä¹‹è¦å®šå­¸åˆ†ã€ç³»è¨‚å°ˆæ¥­é¸ä¿®ç§‘ç›®è‡³å°‘26 å­¸åˆ†ä»¥ä¸ŠåŠæ ¡è¨‚å…±åŒå¿…ä¿®ç§‘ç›®ä¹‹è¦å®šå­¸åˆ†ã€‚"
            "(ä¸‰) å®Œæˆå°ˆé¡Œä¸¦é€šéå°ˆé¡Œå£è©¦åŠç¹³äº¤å°ˆé¡Œå ±å‘Šã€‚"
            "(å››) åƒåŠ  CPE æª¢å®šè€ƒè©¦ä¸¦ç¬¦åˆä»¥ä¸‹ä»»ä¸€æ¨™æº–: 1. å–®æ¬¡ç­”å°2 é¡Œä»¥ä¸Šã€‚2. å¤šæ¬¡ç´¯è¨ˆç­”å°3 é¡Œä»¥ä¸Šã€‚"
            "3. åƒåŠ é4æ¬¡ä»¥ä¸Šçš„æª¢å®šè€ƒè©¦,ä¸¦ä¿®éæœ¬ç³»ä¸€é–€3å­¸åˆ†ä¹‹ç¨‹å¼è¨­è¨ˆç²¾å¯¦æ¼”ç·´ç›¸é—œèª²ç¨‹ä¸”æˆç¸¾åŠæ ¼ã€‚"
            "å››ã€ æœ¬è¦å®šå¦‚æœ‰æœªç›¡äº‹å®œ,æ‚‰ä¾ã€Œå¤§åŒå¤§å­¸å­¸å‰‡ã€åŠã€Œå¤§åŒå¤§å­¸æ ¡è¨‚å…±åŒå¿…ä¿®ç§‘ç›®åŠå­¸åˆ†ã€è¦å®šè¾¦ç†ã€‚"
            "äº”ã€æœ¬è¦å®šç¶“ç³»å‹™æœƒè­°åŠé™¢å‹™æœƒè­°é€šé,å ±è«‹æ•™å‹™æœƒè­°æ ¸å‚™å¾Œå¯¦æ–½,ä¿®è¨‚æ™‚äº¦åŒã€‚\", "
            "\"è³‡æ–™ä¾†æº\": \"https://cse.ttu.edu.tw/var/file/58/1058/img/94/203207450.pdf\", "
            "\"æ¨è«–ä¸»é¡Œ\": \"graduation\", "
            "\"ä¾†æºæª”æ¡ˆ\": \"data_qwen/academic_requirements.json\""
            "}}"
            "\n```\n\n"
            "è«‹ä¾ç…§è¦å‰‡ï¼Œç”¢ç”Ÿä¸€æ®µä¸è¶…é 650 å€‹ä¸­æ–‡å­—çš„è‡ªç„¶èªå¥æè¿°ã€‚"
            "å°æ–¼è¦ç« æ¢æ–‡é¡è³‡æ–™ï¼Œå¿…é ˆé€æ¢è¦†è“‹æ‰€æœ‰æ¢æ¬¾èˆ‡å­æ¢æ¬¾ï¼ˆä¾‹å¦‚ï¼šä¸€ã€äºŒã€ä¸‰ã€(ä¸€)(äºŒ)(ä¸‰)(å››)ã€ä»¥åŠ(å››)ä¸­çš„1/2/3æ¢ä»¶ï¼‰ï¼Œæ¯ä¸€æ¢éƒ½å¿…é ˆåœ¨è¼¸å‡ºä¸­å‡ºç¾ï¼Œä¸”æ•¸å­—é–€æª»ä¸å¯çœç•¥æˆ–æ”¹å¯«éŒ¯èª¤ã€‚"

        ),
        (
            "ai",
            "ã€Œå¤§åŒå¤§å­¸è³‡è¨Šå·¥ç¨‹å­¸ç³»å­¸å£«ç­ä¿®æ¥­è¦å®šã€ä¾ã€Œå¤§åŒå¤§å­¸å­¸å‰‡ã€è¨‚å®šã€Œå¤§åŒå¤§å­¸è³‡è¨Šå·¥ç¨‹å­¸å£«ç­ä¿®æ¥­è¦å®šã€ã€‚ä¿®æ¥­å¹´é™ç‚ºå››å¹´ï¼Œå¾—å»¶é•·å…©å¹´ï¼Œä¼‘å­¸æœŸé–“ä¸åˆ—å…¥ä¿®æ¥­å¹´é™è¨ˆç®—ã€‚ç•¢æ¥­å‰é ˆä¿®å¾—128å­¸åˆ†ä»¥ä¸Šï¼Œæ‰€ä¿®å­¸åˆ†éœ€åŒ…å«ç³»è¨‚å¿…ä¿®ç§‘ç›®ä¹‹è¦å®šå­¸åˆ†ã€ç³»è¨‚å°ˆæ¥­é¸ä¿®ç§‘ç›®è‡³å°‘26å­¸åˆ†ä»¥ä¸ŠåŠæ ¡è¨‚å…±åŒå¿…ä¿®ç§‘ç›®ä¹‹è¦å®šå­¸åˆ†ï¼›ä¸¦éœ€å®Œæˆå°ˆé¡Œã€é€šéå°ˆé¡Œå£è©¦ä¸”ç¹³äº¤å°ˆé¡Œå ±å‘Šã€‚å¦é ˆåƒåŠ CPEæª¢å®šä¸¦ç¬¦åˆä»»ä¸€æ¨™æº–ï¼šå–®æ¬¡ç­”å°2é¡Œä»¥ä¸Šï¼Œæˆ–å¤šæ¬¡ç´¯è¨ˆç­”å°3é¡Œä»¥ä¸Šï¼Œæˆ–åƒåŠ é4æ¬¡ä»¥ä¸Šæª¢å®šä¸”ä¿®éæœ¬ç³»ä¸€é–€3å­¸åˆ†ä¹‹ç¨‹å¼è¨­è¨ˆç²¾å¯¦æ¼”ç·´ç›¸é—œèª²ç¨‹ä¸¦æˆç¸¾åŠæ ¼ã€‚æœªç›¡äº‹å®œæ‚‰ä¾ã€Œå¤§åŒå¤§å­¸å­¸å‰‡ã€åŠã€Œå¤§åŒå¤§å­¸æ ¡è¨‚å…±åŒå¿…ä¿®ç§‘ç›®åŠå­¸åˆ†ã€è¦å®šè¾¦ç†ï¼›æœ¬è¦å®šç¶“ç³»å‹™æœƒè­°åŠé™¢å‹™æœƒè­°é€šéï¼Œå ±è«‹æ•™å‹™æœƒè­°æ ¸å‚™å¾Œå¯¦æ–½ï¼Œä¿®è¨‚æ™‚äº¦åŒã€‚ä¸»é¡Œç‚ºgraduationã€‚è³‡æ–™ä¾†æºï¼šhttps://cse.ttu.edu.tw/var/file/58/1058/img/94/203207450.pdf"
        ),
        # === é€šç”¨æ¨¡æ¿ ===
        (
            "human",
            "è³‡æ–™é¡å‹ (schema_hint)ï¼š{schema_hint}\n\n"
            "ä»¥ä¸‹æ˜¯ä¸€ç­† JSON è³‡æ–™ï¼š\n"
            "```json\n{record_json}\n```\n\n"
            "è«‹ç›´æ¥è¼¸å‡ºæè¿°å¥ï¼Œé•·åº¦è«‹æ§åˆ¶åœ¨ä¸è¶…é {max_chars} å€‹ä¸­æ–‡å­—ï¼Œ"
            "ç›´æ¥è¼¸å‡ºæè¿°å¥ï¼Œä¸è¦å¤šåšèªªæ˜ã€‚"
        ),
    ])

    return (prompt | llm | StrOutputParser())


def _get_rewriter_chain():
    global _json_rewriter_chain
    if _json_rewriter_chain is None:
        _json_rewriter_chain = _build_rewriter_chain()
    return _json_rewriter_chain


def _post_process(text: str) -> str:
    """ä¿éšªèµ·è¦‹ï¼Œå†æŠŠå¯èƒ½å‡ºç¾çš„ <think> é¡åƒåœ¾ç æ‰ã€‚"""
    if not text:
        return ""

    # ç æ‰ <think> ... </think>ï¼ˆå¦‚æœæœ‰ï¼‰
    text = re.sub(r"<think>.*?</think>", "", text, flags=re.DOTALL)

    # ç æ‰é–‹é ­é‚£ç¨®ã€Œå¥½çš„ï¼Œç¾åœ¨æˆ‘è¦è™•ç† JSONâ€¦ã€ä¹‹é¡çš„ meta
    bad_prefixes = [
        "å¥½çš„ï¼Œæˆ‘ç¾åœ¨éœ€è¦è™•ç†",
        "å¥½çš„ï¼Œæˆ‘ç¾åœ¨è¦è™•ç†",
        "é¦–å…ˆï¼Œæˆ‘æœƒ",
        "æ ¹æ“šä½¿ç”¨è€…çš„æŒ‡ç¤º",
        "æˆ‘ç¾åœ¨éœ€è¦å°‡é€™ç­† JSON",
    ]
    for p in bad_prefixes:
        if text.strip().startswith(p):
            # å¾ˆç²—æš´ï¼Œä½†å¯¦å‹™ä¸Šå¸¸å¸¸æœ‰æ•ˆï¼šå–æœ€å¾Œä¸€æ®µæˆ–æœ€å¾Œä¸€å…©å¥
            parts = re.split(r"[ã€‚ï¼!ï¼Ÿ?]", text)
            parts = [s.strip() for s in parts if s.strip()]
            if parts:
                text = "ã€‚".join(parts[-2:])  # å–æœ€å¾Œ 1â€“2 å¥
            break

    return text.strip()


def rewrite_json_record(
    record: Dict[str, Any],
    schema_hint: Optional[str] = None,
    max_chars: int = 400,
) -> str:
    """
    å°‡ã€Œå–®ç­† JSON ç‰©ä»¶ã€è½‰æˆä¸€å°æ®µé©åˆ RAG çš„ä¸­æ–‡æè¿°ã€‚
    schema_hint ç”¨ä¾†å‘Šè¨´ LLM é€™æ˜¯å“ªç¨®è³‡æ–™ï¼ˆå¸«è³‡ / èª²ç¨‹ / è¡Œäº‹æ›† / æœ€æ–°æ¶ˆæ¯...ï¼‰ã€‚
    """
    global _rewrite_counter

    chain = _get_rewriter_chain()
    hint = schema_hint or "å¤§åŒå¤§å­¸ç›¸é—œè³‡æ–™"

    # ğŸ”¹ é å…ˆç®—å‡ºã€Œé€™ä¸€ç­†ã€çš„ç·¨è™Ÿï¼ˆå› ç‚º _rewrite_counter æ˜¯åœ¨å‘¼å«å®Œå¾Œæ‰ +1ï¼‰
    next_index = _rewrite_counter + 1

    # ğŸ”¹ å¦‚æœé€™ä¸€ç­†åœ¨æˆ‘å€‘æƒ³çœ‹çš„ debug æ¸…å–®è£¡ï¼Œå°±æŠŠåŸå§‹ JSON dump å‡ºä¾†
    if next_index in DEBUG_REWRITE_INDICES:
        print("\n===== [json_rewriter DEBUG] åŸå§‹ record =====")
        print(f"é‡å¯«ç·¨è™Ÿ : {next_index}")
        print(f"schema   : {hint}")
        print("record_json =")
        print(json.dumps(record, ensure_ascii=False, indent=2))
        print("===== [json_rewriter DEBUG END] =====\n")

    raw = chain.invoke({
        "schema_hint": hint,
        "record_json": json.dumps(record, ensure_ascii=False, indent=2),
        "max_chars": max_chars,
    })

    _rewrite_counter += 1
    # æ¯ 10 ç­†å°ä¸€æ¬¡ï¼ˆè‡ªå·±èª¿æ•´é »ç‡ï¼‰
    if _rewrite_counter == 1 or _rewrite_counter % 10 == 0:
        print(f"[json_rewriter] å·²é‡å¯« {_rewrite_counter} ç­†ï¼ˆschema_hint={hint}ï¼‰")

    return _post_process(raw or "")
